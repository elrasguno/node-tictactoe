<!doctype html>
<html>
  <head>
    <title>node-websocket-server test</title>
		<style type="text/css">
#rockbar {
	position: relative;
	top: 0;
	left: 20px;
	background: #fff;
	padding: 0.5em;
	display: none;
}

#warning {
	padding: 1em;
	border: 2px solid red;
}

#log {
	float: right;
	width: 23%;
	border: 1px solid #ccc;
}

#ttt_container {
	width : 50%;
	margin : 0 auto;
}
#ttt_container > ul {
	list-style-type: none;
	width: 100%;
}
#ttt_container > ul > li {
	width : 31%;
	line-height: 3em;
	text-align: center;
	font-size: 3em;
	display: inline-block;
	border: 2px solid #069;
	margin-top: 5px;
}
		</style>
	<script type="text/javascript" src="../JSON-js/json2.js"></script>
	<script type="text/javascript" src="http://bit.ly/jqsource"></script>
  </head>
  <body>
	  <div id="rockbar">
			<a href="#" id="send">Send Something</a> | <a href="#" id="spam">Run Spam Test</a> | <a href="#" id="close">Close Connection.</a> | <a href="#" id="open">Open Connection.</a>
		</div>

		<div id="log"></div>
		<div id="ttt_container">
			<ul>
				<li id="space_0">&nbsp;</li>
				<li id="space_1">&nbsp;</li>
				<li id="space_2">&nbsp;</li>
				<li id="space_3">&nbsp;</li>
				<li id="space_4">&nbsp;</li>
				<li id="space_5">&nbsp;</li>
				<li id="space_6">&nbsp;</li>
				<li id="space_7">&nbsp;</li>
				<li id="space_8">&nbsp;</li>
			</ul>

		</div>
    <script type="text/javascript">
var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

function pad(n) {
  return n < 10 ? '0' + n.toString(10) : n.toString(10);
}

function timestamp() {
  var d = new Date();
  return [
    d.getDate(),
    months[d.getMonth()],
    [ pad(d.getHours())
    , pad(d.getMinutes())
    , pad(d.getSeconds())
    , (d.getTime() + "").substr( - 4, 4)
    ].join(':')
  ].join(' ');
};


function scrollToBottom() {
    window.scrollBy(0, document.body.scrollHeight - document.body.scrollTop);
};

function log(data){
  output_log.innerHTML += timestamp()+": "+data+"<br />";
  scrollToBottom();
}


var conn, recvd, connections = 0;
var output_log = document.getElementById("log");
var connect = function() {
  if (window["WebSocket"]) {
    recvd = 0;
    //host = (document.location.host != "" ? document.location.host : "localhost:8000");
    host = "localhost:8000";
    conn = new WebSocket("ws://"+host+"/test");
    conn.onmessage = function(evt) {
		var vResponse;
		try {
			vResponse = JSON.parse(evt.data);	
		} catch (e) {
			log(evt.data);
			return;
		}

		// Parse evt.data and route to appropriate function.
		if (tttcli[vResponse.type]) 
		{	
			tttcli[vResponse.type](vResponse);	
		} else {
			console.log('whoops', vResponse);
		}
		vResponse.msg && log(vResponse.msg);
    };
    
    conn.onerror = function() {
      log("error", arguments);
    };
    
    conn.onclose = function() {
      log("closed");
    };

    conn.onopen = function() {
      log("opened");
    };
  }
};

var tttcli = (function() {
	return {
		_player_id     : null,
		_player_letter : null,

		getPlayerID     : function()  { return this._player_id;         },
		setPlayerID     : function(v) { return this._player_id = v;     },
		getPlayerLetter : function()  { return this._player_letter;     },
		setPlayerLetter : function(v) { return this._player_letter = v; },

		// Set values after successfull connection;
		connection : function(rRespObj)
		{
			var vData = (rRespObj && rRespObj.data);
			if (!vData) return false;

			console.log('tttcli.connection', rRespObj);
			if (vData.player_id && vData.player_letter)
			{
				this.setPlayerID(vData.player_id);
				this.setPlayerLetter(vData.player_letter);
			}
		},

		// Called after successful run of playTurn
		playTurn : function(rRespObj)
		{
			console.log('playTurn', rRespObj);
			// Check result for true (win)
			// Update board.
		}
	}
})();

$(document).ready(function() {
	connect();
	console.log('ttlcli', tttcli);
	// Store player info returned from server.

	$('#ttt_container').click(function(rEvt) {
		var vSlotIdx, vPlayer, vCmdObj;
		// Get slot # from rEvt.target.id
		vSlotIdx = parseInt(rEvt.target.id.split('_')[1]);

		// Get stored player number/letter
		vPlayer  = tttcli.getPlayerLetter();

		// Pass command
		vCmdObj  = {
			"cmd"  : "playTurn",
			"args" : [vPlayer, vSlotIdx] 
		};
		console.log('click', vSlotIdx, vPlayer, vCmdObj);

		conn.send(JSON.stringify(vCmdObj));

		// Throw error on failure

		// Update UI on success

		// { "cmd" : "playTurn", "args" : ["X", 1]}
	});
});

    </script>
  </body>
</html>